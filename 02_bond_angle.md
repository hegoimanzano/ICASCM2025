# Topology

In any molecular dynamics (MD) simulation package, a **topology** file (sometimes also called a _structure_ or _data file_) is a critical file for the simulation. While the input script tells the program _how to run_ the dynamics (ensembles, temperature control, run length, etc.), the topology tells it _what system_ is being simulated. This includes a complete description of all particles: their identifiers, element or species type, masses, charges, and spatial coordinates, along with the connectivity information that defines which atoms are bonded, and how angles and dihedrals are defined. Without such information, the force field cannot assign the correct interactions (bond stretching, angle bending, torsional rotations, and nonbonded forces). In short, the topology is the “map” that defines the system at the atomic scale.

Constructing this file correctly is often the most tedious part of a simulation. In a system with more than 1,000 atoms, it is necessary to define thousands of bonds, angles, dihedrals, etc., which is not straightforward. Here, we will build the topology file using **VMD** (Visual Molecular Dynamics) starting from the atomic structure generated by the pyCSH code. VMD is a molecular visualisation program for displaying, animating, and analysing large biomolecular systems using 3D graphics and built-in scripting. It is particularly useful for preparing input files for molecular dynamics simulations with software such as LAMMPS.

> ✏️ **Novice users** will build the LAMMPS data file with the full topological information using VMD.
> _Estimated time XXX min_.

> ✒️ **Advanced users** will build the LAMMPS data file with the full topological information using VMD from the terminal with scripts.
> _Estimated time XXX min_.

```{Note}
There are alternative ways to generate topology files, from automated tools such as LigParGen or Moltemplate to custom scripts using Python and ASE. Each method offers different levels of flexibility and complexity.
```

### LAMMPS topology file

```{Note}
Users with experience with force fields that require topology (ClayFF, CSHFF, CHARMM, OPLS, etc.) can skip this section.
```

In LAMMPS, the topological information is usually stored in a **data file**, which is read using the `read_data` command. The structure of this file is modular and well defined:

- A **header** section specifies the total and type numbers of atoms, bonds, angles, dihedrals, and impropers, as well as the dimensions of the simulation box.
- A **Masses** section assigns masses to each atom type.
- An **Atoms** section provides, for each atom, its ID, molecule ID (if relevant), atom type, charge, and coordinates (x, y, z). Depending on the chosen `atom_style` in the input file, additional fields may appear, such as velocities, dipoles, or extra properties.
- Optional **Bonds, Angles, Dihedrals, and Impropers** sections describe bonded connectivity, listing the IDs of the participating atoms and their type.

As an example, the following snippet shows a simplified LAMMPS data file. It includes the main structure and sections found in a topology file for a simulation using the ClayFF force field:

```lammps
LAMMPS data file for ClayFF toy model
9 atoms
3 bonds
1 angles

7 atom types
2 bond types
1 angle types

0.0 20.0 xlo xhi
0.0 20.0 ylo yhi
0.0 20.0 zlo zhi

Masses # atom type, atom mass

1 28.0855    # Si
2 15.9994    # O_br
3 15.9994    # O_H
4 1.008      # H (OH group)
5 40.078     # Ca
6 15.9994    # O_w (water oxygen)
7 1.008      # H_w (water hydrogen)

Atoms # atom-ID molecule-ID atom-type charge x y z

1 1 1  2.100  10.0 10.0 10.0   # Si
2 1 2 -1.050  11.5 10.0 10.0   # O_br
3 1 2 -1.050   8.5 10.0 10.0   # O_br
4 1 3 -0.950  10.0 11.0 10.0   # O_H
5 1 4  0.425  10.0 11.9 10.0   # H (OH group)
6 2 5  2.000  12.0 10.0 10.0   # Ca
7 3 6 -0.820  10.0  9.0 10.0   # O_w (water oxygen)
8 3 7  0.410  10.0  8.1 10.0   # H_w (water hydrogen)
9 3 7  0.410  10.0  8.1 10.0   # H_w (water hydrogen)

Bonds # bond-ID bond-type atom1 atom2

1 1 4 5   # O_H – H (hydroxyl bond)
2 2 7 8   # O_w – H_w (water bond)
3 2 7 9   # O_w – H_w (water bond)

Angles # angle-ID angle-type atom1 atom2 atom3

1 1 8 7 9  # H_w – O_w – H_w (water angle) 
```

```{Note}
**Atom styles and force fields** The structure of a LAMMPS data file partly depends on the force field being used, as each force field requires a specific `atom_style`. For instance, classical force fields such as CHARMM, AMBER, or ClayFF use the `full` style. This format explicitly lists all topological terms — bonds, angles, dihedrals, and impropers — together with atom types, masses, charges, and coordinates. In contrast, ReaxFF does not rely on predefined connectivity and the data files should use the `charge` style, which only specifies atom IDs, types, charges, masses, and coordinates.  
Regardless of the force field, the **data file must be consistent with the `atom_style` defined in the input script**, otherwise the simulation will fail to read it correctly. You can find a complete description of all available atom styles and their required fields in the [LAMMPS documentation](https://docs.lammps.org/atom_style.html).
```

### ClayFF atom types 

[ClayFF](https://doi.org/10.1021/jp0363287) was originally developed to describe clays and layered silicates, but has become common for modelling calcium silicate hydrate (C–S–H) and related phases. Its key advantage lies in its simplicity: ClayFF is essentially a non-bonded force field in which most atoms interact only through Lennard–Jones and Coulombic terms. The only exceptions are hydroxyl and water molecules, where explicit O–H bonds and H–O–H angles are included to preserve molecular geometry, although [later extensions of ClayFF](https://doi.org/10.1021/acs.jpcc.1c04600) introduced additional M–O–H (e.g. Si–O–H, Al–O–H) angular terms to better describe hydroxylated surfaces and edges, such as those found in C–S–H. This means that framework atoms such as Si, Al, and Ca are modelled as charged point particles interacting electrostatically with oxygens and hydroxyls, without any explicit bond definition. The assigned charges are fractional (e.g., O_br ≈ –1.05 e, Si ≈ +2.1 e) and were originally parameterised for clay minerals (see the **Caution** note).

ClayFF defines a limited set of atom types, each with specific Lennard–Jones parameters and partial charges. Typical species include:
- O_br (bridging oxygen): oxygens linking tetrahedra.
- O_H (hydroxyl oxygen) and H (hydroxyl hydrogen): forming bonded terms.
- Tetrahedral cations (Si, Al_t).
- Octahedral cations (Al_o, Mg, Fe, Ca).
- Interlayer water molecules (O_w, H_w).
- Common aqueous ions (Na⁺, Ca²⁺, Cl⁻, etc.).

```{Caution}
Clays are phyllosilicates, whereas tobermorite minerals and C–S–H are inosilicates, so applying ClayFF’s standard partial charges to these systems results in a non-neutral configuration. Maintaining electroneutrality is crucial for obtaining stable and physically meaningful simulations. It is **essential** to ensure that your system is **_formally_** neutral, i.e. the sum of the formal charges equals zero. Then, the partial charges can be slightly adjusted:
 - If the net charge is small (|Q| < 0.1 e), it can be compensated by the Ewald solver.  
 - If the net charge is large (|Q| > 0.1 e), you need to adjust the standard charges in your model. The simplest approach is to modify the charge in the silicate oxygen atoms by a tiny percentage (typically < 0.05%). Ideally, the force field paramenters should be rescaled, but we can assume that such a minor charge modification will not affect the underlying physics.
**IMPORTANT**: the same issue applies to any force field with partial charges when "defects" are introduced, such as CSHFF, OPLS, etc.
```

### Novice users: step-by-step guide to generate the topology file in VMD

In this section, we will create a LAMMPS data file from the structure generated by pyCSH, using VMD and its plugin *TopoTools*. pyCSH generates atomic structures in VASP format (.vasp), which includes the atomic positions and the periodic simulation cell.

```{Note}
VMD can read a wide range of structure formats, including `.pdb`, `.xyz`, `.mol2`, `.data`, `.cif`, and various VASP files (`POSCAR`, `CONTCAR`, `XDATCAR`).
```

**1. Loading the structure in VMD**

Open VMD and load your structure by going to `File → New Molecule`. In the window that appears, click `Browse`, select your `.vasp` file, and then choose “VASP_POSCAR” as the file type in the `Determine file type` dropdown list. Finally, click `Load` to visualise it in the main display.

**2. Loading TopoTools and PBCtools to create the LAMMPS data file**

*TopoTools* is a VMD plugin that provides a set of commands to manipulate molecular topologies and export them to formats compatible with LAMMPS. The *PBCtools* package, in turn, allows handling and visualising periodic boundary conditions (PBC). To load both, open the `Tk Console` by clicking on `Extensions/Tk Console` and type:
```
package require topotools
package require pbctools
```

**3. Defining the simulation box** 

Next, set the periodic boundary conditions (PBC) for your system. The first three numbers correspond to the box dimensions along *x*, *y*, and *z* (in Å), and the last three specify the angles between the box edges. Make sure these values match those defined in the structure generated by pyCSH:
```
pbc set {20.0 20.0 20.0 90.0 90.0 90.0}
```

**4. Generating bonds, angles, dihedrals, and impropers**

Now use TopoTools to reconstruct the molecular topology from the atomic coordinates. The following commands recalculate bonds and then generate angle, dihedral, and improper (used to maintain planarity in certain molecular structures) terms:
```
mol bondsrecalc top
topo guessangles
topo guessdihedrals
topo guessimpropers
```

```{Tip}  
ClayFF does not include any dihedral or improper terms, as molecular geometry is maintained solely through non-bonded interactions and the explicit O–H and H–O–H bonds and angles. Therefore, you should avoid running the commands `topo guessdihedrals` and `topo guessimpropers` since they would create unwanted lists in the data file that are incompatible with the ClayFF model and should be removed before using the file in LAMMPS.
```

Once this is done, reanalyse the molecule to ensure that the topology is fully consistent by typing:
```
mol reanalyze top
```

```{Warning}
**Avoiding unwanted bonds and angles in ClayFF systems.** When using TopoTools to guess bonds and angles, VMD automatically generates all possible connections based on interatomic distances. However, in ClayFF, only hydroxyl and water molecules should contain explicit bonds and angles. If you keep the default settings, VMD will create unnecessary bonds and angles such as *Ca–O_w* or *Si–O_br–Si*, which are not part of the ClayFF model. To avoid this, you can assign a radius of zero to atoms that should not form bonds before recalculating connectivity (`mol reanalyze top`). In this way, VMD will not find any neighbouring atoms within the bonding cutoff distance, and therefore no connectivity will be generated for those atoms. To do so, use the following command:

    set O_br [atomselect top "name O_br"]
    $O_br set radius 0
```

**5. Assigning atomic charges**

Atomic charges must be defined explicitly using the partial charges specified by ClayFF:
```
set Si [atomselect top "name Si"]
$Si set charge 2.10
set O_br [atomselect top "name O_br"]
$O_br set charge -1.05
...
```

```{Warning} 
**Handling mislabeled atoms in VMD.** VMD automatically assigns the chemical element of each atom based on the first one or two characters of its name. It first checks if the first two characters correspond to a valid chemical symbol. If not, it uses only the first character. This simple rule often leads to misassignments when using custom atom names. For instance, if you rename calcium to `Cw`, VMD will treat it as carbon (C) or an oxygen atom renamed to Os will be interpreted as a osmium (Os), assigning incorrect masses and radii, which can, in turn, affect the bond recognition. To fix this issue while preserving your custom atom names, you need to manually set the correct physical properties by typing:

    set Os [atomselect top "name Os"]
    $Os set mass 15.9994
    $Os set radius 1.52
```

**6. Writing the LAMMPS data file:**

Finally, export the topology into a LAMMPS-compatible format using:
```
topo writelammpsdata atoms.data full
```
This command creates the file `atoms.data` in the `full` style, which includes all atom, bond, angle, and dihedral information required by LAMMPS. You can open it in any text editor to check its structure — you should see sections such as *Masses*, *Atoms*, *Bonds*, and *Angles*. This file is now ready to be combined with the force-field parameters in your LAMMPS input script.


### Advanced users: script based construction

Instead of opening VMD and typing commands in the `Tk Console`, you can run VMD directy from the terminal and execute all steps automatically with a *Tcl script*. A Tcl script is a plain-text file containing the VMD commands you would otherwise type manually in the Tk Console. This approach is ideal for automating workflows: once your Tcl script works for one structure, it can be easily reused to generate multiple data files — for example, for a series of C–S–H models with different Ca/Si ratios — by creating an additional shell script that calls the same Tcl pipeline for each `.vasp` file. This allows you to build many systems in sequence without any manual intervention.

**1. Building the Tcl script**

The first step is to create a Tcl script (a text file with the extension `.tcl`) that VMD will read and execute line by line. Each command inside corresponds to what you would type in the Tk Console (see section above), but grouped into a single automated workflow. The only difference is that you must include an additional command `mol new system.vasp type POSCAR` (where *system* is the name of your structure) at the beginning to load the structure to be processed. Therefore, the Tcl script should:

- **Load the structure** of the system, the `.vasp` file. 
- **Load the necessary packages**, such as `topotools` and `pbctools`.  
- **Define the simulation box dimensions**, using `pbc set`.  
- **Assign correctly the elements** to any custom-named atoms (fix mislabelled atoms).  
- **Set atomic masses and charges**, following the ClayFF parameters.
- **Set radious**, assigning radius zero to atoms that must not form bonds.
- **Rebuild the topology**, using `mol bondsrecalc` and `topo guessangles`.  
- **Export** the system using `topo writelammpsdata`.
  
**2. Running VMD with a Tcl script**

Once your Tcl script (e.g. `vasp2data.tcl`) is ready, the next step is to run it directly from the terminal. To do this, we should call the VMD executable in and use the option `-dispdev text` to excute the Tcl script specified after `-e`:
```
vmd -dispdev text -e vasp2data.tcl
```

This starts VMD without the graphical interface, loads your `.vasp` structure with `type POSCAR`, applies all steps in the script, and writes `atoms.data` in the current working directory.

This starts VMD without opening the graphical interface, automatically loads the `.vasp` file, applies all the steps in the script, and writes the output file `.data in the current working directory.

```{Tip}
If your terminal does not recognise the `vmd` command, use the full path to the executable (e.g. on macOS: `"/Applications/VMD 1.9.4a51.app/Contents/vmd/vmd_MACOSXX86_64" -dispdev text -e vasp2data.tcl`).  
```

